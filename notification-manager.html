<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="notification-overlay.html">

<!--
`notification-manager`

warning, error, notify-warning

@demo demo/index.html 
-->

<dom-module id="notification-manager">
  <template>
  </template>

  <script>

    class NotificationManager extends Polymer.Element {

      static get is() {return 'notification-manager';}

      static get config() {
        return {
          properties: {

            listenersTarget: {
              type: Object,
              value: document.body
            },

            disabled: {
              type: Boolean,
              value: false
            },

            _overlays: {
              type: Array,
              value: _ => {
                return [];
              }
            }

          },

          observers: [
            '_overlaysChanged(_overlays.length)'
          ]
        };
      }

      constructor() {
        super();
        this.notify = this.notify.bind(this);
      }

      connectedCallback() {
        super.connectedCallback();

        requestAnimationFrame(_ => {
          this._toggleListeners(true);
        });
      }

      disconnectedCallback() {
        this._toggleListeners(false);
        super.disconnectedCallback();
      }

      notify(event) {
        if (event.defaultPrevented ||Â this.disabled) {
          return;
        }

        const type = event.type.replace('notify-', '');
        const text = event.detail.text;
        const duration = event.detail.duration || Infinity;

        const overlay = document.createElement('notification-overlay')
        overlay.type = type;
        overlay.text = text;
        overlay.duration = duration;

        overlay.onDetach = _ => {
          this.splice('_overlays', this._overlays.indexOf(overlay), 1);
        };

        this.push('_overlays', overlay);
        overlay.open();
      }

     _toggleListeners(enable) {
        const m = enable ? 'addEventListener' : 'removeEventListener';

        this.listenersTarget[m]('notify-error', this.notify);
        this.listenersTarget[m]('notify-warning', this.notify);
        this.listenersTarget[m]('notify-info', this.notify);
        this.listenersTarget[m]('notify-success', this.notify);
      }

      _overlaysChanged(changes) {
        this._positionizeOverlays();
      }

      _positionizeOverlays() {
        this._updateRects();

        this._overlays.forEach((overlay, index) => {
          let top = 10;

          if (index) {
            let i = index;

            while(i--) {
              top += this._rects[i].height + 4;
            }
          }

          overlay.style.top = top + 'px';
        });
      }

      _updateRects() {
        this._rects = this._overlays.map(overlay => {
          return overlay.getBoundingClientRect();
        });
      }

    }

    customElements.define(NotificationManager.is, NotificationManager);

  </script>
</dom-module>